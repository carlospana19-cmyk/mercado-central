# üìö WIKI - Migraci√≥n de Proyecto Supabase

## üéØ Objetivo
Migrar completamente el proyecto "Mercado Central" de un proyecto Supabase antiguo a uno nuevo debido a que se excedi√≥ el l√≠mite del plan gratuito.

---

## üìã Contexto

### Proyecto Original
- **Nombre:** Mercado Central Project
- **URL:** https://tinjpodtyydloleepbmb.supabase.co
- **Estado:** Bloqueado por exceder l√≠mite de plan gratis
- **Base de datos:** Tiene todas las tablas, datos y configuraciones funcionando

### Proyecto Nuevo
- **Nombre:** mercadocentral-v2
- **URL:** https://ldtomnicwnwituyensmn.supabase.co
- **Anon Key:** sb_publishable_IhsU4XOQCR8R83oZEXhVAA_W_8v6Fik
- **Estado:** Vac√≠o, listo para migrar

---

## üóÇÔ∏è Tablas a Migrar (en orden de dependencias)

1. ‚úÖ **profiles** - Perfiles de usuarios
2. ‚úÖ **provincias** - Lista de provincias
3. ‚úÖ **categorias** - Categor√≠as jer√°rquicas de anuncios
4. ‚è≥ **anuncios** - Publicaciones de productos/servicios
5. ‚è≥ **imagenes** - Im√°genes de anuncios
6. ‚è≥ **likes** - Sistema de favoritos
7. ‚è≥ **plan_tokens** - Tokens para planes
8. ‚è≥ **cortesias_aplicadas** - Cortes√≠as asignadas
9. ‚è≥ **reviews** - Rese√±as de vendedores
10. ‚è≥ **user_plans** - Planes de usuarios

---

## üìù Estructura de Tablas

### 1. categorias
```sql
CREATE TABLE public.categorias (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nombre text NOT NULL UNIQUE,
  parent_id integer,
  CONSTRAINT categorias_parent_id_fkey FOREIGN KEY (parent_id) REFERENCES public.categorias(id) ON DELETE SET NULL
);

CREATE INDEX IF NOT EXISTS idx_categorias_parent_id ON public.categorias(parent_id);
ALTER TABLE public.categorias ENABLE ROW LEVEL SECURITY;
```

**Datos:** 79 categor√≠as con jerarqu√≠a padre-hijo

### 2. provincias
```sql
CREATE TABLE public.provincias (
  id integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  nombre text NOT NULL UNIQUE
);
```

**Datos a insertar:**
- San Jos√©
- Alajuela
- Cartago
- Heredia
- Guanacaste
- Puntarenas
- Lim√≥n

### 3. profiles
```sql
CREATE TABLE public.profiles (
  id uuid PRIMARY KEY,
  telefono text,
  email text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  nombre_completo text,
  whatsapp text,
  nombre_negocio text,
  tipo_negocio text,
  descripcion text,
  provincia text,
  distrito text,
  direccion text,
  url_foto_perfil text,
  is_admin boolean DEFAULT false,
  CONSTRAINT profiles_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id)
);
```

### 4. anuncios
```sql
CREATE TABLE public.anuncios (
  id bigint GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  created_at timestamp with time zone DEFAULT now(),
  titulo text,
  descripcion text,
  precio numeric,
  categoria text,
  ubicacion text,
  user_id uuid,
  url_portada text,
  url_galeria text[],  -- Array de texto
  atributos_clave jsonb,
  direccion_especifica text,
  contact_name text,
  contact_phone text,
  provincia text,
  distrito text,
  featured_plan text DEFAULT 'free',
  fecha_publicacion timestamp with time zone DEFAULT now(),
  visitas integer DEFAULT 0,
  featured_until timestamp with time zone,
  enhancements jsonb,
  max_images integer DEFAULT 3,
  plan_priority integer DEFAULT 0,
  contact_email text,
  is_sold boolean DEFAULT false,
  url_video character varying,
  publicar_redes boolean DEFAULT false,
  CONSTRAINT anuncios_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT fk_anuncios_user_id FOREIGN KEY (user_id) REFERENCES public.profiles(id)
);
```

---

## ‚öôÔ∏è Configuraciones Necesarias

### 1. Variables de Entorno (.env.local)
```
NEXT_PUBLIC_SUPABASE_URL=https://ldtomnicwnwituyensmn.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=sb_publishable_IhsU4XOQCR8R83oZEXhVAA_W_8v6Fik
```

### 2. Archivo supabase-client.js
```javascript
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabaseUrl = 'https://ldtomnicwnwituyensmn.supabase.co'
const supabaseAnonKey = 'sb_publishable_IhsU4XOQCR8R83oZEXhVAA_W_8v6Fik'

export const supabase = createClient(supabaseUrl, supabaseAnonKey)
```

### 3. Storage - Bucket anuncios
- Crear bucket: `anuncios`
- Configurar como p√∫blico
- Permisos: lectura p√∫blica, escritura autenticada

### 4. Authentication
- Desactivar confirmaci√≥n por email (para desarrollo)
- Permitir registro de usuarios

---

## üîÑ Proceso de Migraci√≥n Paso a Paso

### Paso 1: Limpiar el nuevo proyecto
```sql
-- Eliminar todas las tablas si existen (en orden inverso de dependencias)
DROP TABLE IF EXISTS public.user_plans;
DROP TABLE IF EXISTS public.reviews;
DROP TABLE IF EXISTS public.cortesias_aplicadas;
DROP TABLE IF EXISTS public.plan_tokens;
DROP TABLE IF EXISTS public.likes;
DROP TABLE IF EXISTS public.imagenes;
DROP TABLE IF EXISTS public.anuncios;
DROP TABLE IF EXISTS public.categorias;
DROP TABLE IF EXISTS public.provincias;
DROP TABLE IF EXISTS public.profiles;
```

### Paso 2: Crear tablas en orden
1. profiles
2. provincias
3. categorias
4. anuncios
5. imagenes
6. likes
7. plan_tokens
8. cortesias_aplicadas
9. reviews
10. user_plans

### Paso 3: Configurar RLS y pol√≠ticas
- Habilitar RLS en cada tabla
- Crear pol√≠ticas de lectura p√∫blica (SELECT para anon y authenticated)
- Crear pol√≠ticas de escritura para authenticated
- Crear pol√≠ticas de borrado para admin

### Paso 4: Poblar datos
- Insertar provincias (7 registros)
- Insertar categor√≠as (79 registros con jerarqu√≠a)
- Los anuncios y dem√°s datos se crean por usuarios

### Paso 5: Configurar Storage
- Crear bucket `anuncios`
- Hacer p√∫blico el bucket
- Configurar pol√≠ticas de acceso

### Paso 6: Actualizar c√≥digo frontend
- Actualizar supabase-client.js con nuevas credenciales
- Verificar que todas las consultas usen los nombres de columnas correctos
- Reiniciar servidor de desarrollo

---

## ‚ö†Ô∏è Problemas Comunes y Soluciones

### Error: "process is not defined"
**Causa:** Intentar usar variables de entorno sin el prefijo NEXT_PUBLIC_ en el cliente  
**Soluci√≥n:** Usar importaci√≥n desde CDN o asegurar que las variables tengan NEXT_PUBLIC_

### Error: "column parent_id does not exist"
**Causa:** El c√≥digo busca parent_id pero la tabla usa padre (UUID)  
**Soluci√≥n:** Mantener la estructura original con parent_id (integer)

### Error: "duplicate key value violates unique constraint"
**Causa:** Intentar insertar valores duplicados en columnas UNIQUE  
**Soluci√≥n:** Verificar que los datos no se dupliquen antes de insertar

### Error: "Invalid login credentials"
**Causa:** Usuario no existe o no est√° confirmado  
**Soluci√≥n:** Crear usuario desde panel de Supabase o desactivar confirmaci√≥n por email

### Error: "relation does not exist"
**Causa:** Tabla no creada o nombre incorrecto  
**Soluci√≥n:** Verificar que la tabla exista y el nombre sea correcto

### Error: Storage 400 Bad Request
**Causa:** Bucket no existe o no tiene permisos  
**Soluci√≥n:** Crear bucket y configurar como p√∫blico

---

## üìä Datos Exportados del Proyecto Original

### Categor√≠as (79 registros)
Ver archivo SQL completo con todos los INSERT

### Provincias (7 registros)
```sql
INSERT INTO public.provincias (nombre) VALUES
('San Jos√©'),
('Alajuela'),
('Cartago'),
('Heredia'),
('Guanacaste'),
('Puntarenas'),
('Lim√≥n');
```

---

## üîß Comandos √ötiles

### Verificar que una tabla existe
```sql
SELECT * FROM public.categorias LIMIT 5;
```

### Contar registros
```sql
SELECT COUNT(*) FROM public.categorias;
```

### Limpiar datos de una tabla
```sql
DELETE FROM public.categorias;
```

### Desactivar RLS temporalmente (solo para pruebas)
```sql
ALTER TABLE public.categorias DISABLE ROW LEVEL SECURITY;
```

### Ver pol√≠ticas de una tabla
```sql
SELECT * FROM pg_policies WHERE tablename = 'categorias';
```

---

## üì¶ Orden Recomendado de Ejecuci√≥n

1. ‚úÖ Actualizar variables de entorno (.env.local)
2. ‚úÖ Actualizar supabase-client.js
3. ‚úÖ Crear extensi√≥n pgcrypto (para UUIDs)
4. ‚úÖ Crear tabla profiles
5. ‚úÖ Crear tabla provincias e insertar datos
6. ‚úÖ Crear tabla categorias con RLS y pol√≠ticas
7. ‚úÖ Insertar datos de categor√≠as
8. ‚úÖ Crear tabla anuncios con todas sus columnas
9. ‚úÖ Crear tablas restantes (imagenes, likes, etc.)
10. ‚úÖ Configurar Storage bucket
11. ‚úÖ Reiniciar servidor de desarrollo
12. ‚úÖ Probar login/registro
13. ‚úÖ Probar creaci√≥n de anuncio
14. ‚úÖ Verificar que las categor√≠as y provincias se muestren

---

## üéØ Estado Actual

- ‚úÖ Variables de entorno actualizadas
- ‚úÖ supabase-client.js configurado con CDN
- ‚úÖ Tabla categorias creada con estructura correcta
- ‚úÖ RLS y pol√≠ticas configuradas
- ‚è≥ Pendiente: Poblar categor√≠as
- ‚è≥ Pendiente: Crear tabla provincias
- ‚è≥ Pendiente: Crear tabla anuncios
- ‚è≥ Pendiente: Configurar Storage
- ‚è≥ Pendiente: Probar frontend completo

---

## üìù Notas Importantes

1. **NO usar UUID en tablas que originalmente usaban integer** - Mantener compatibilidad con c√≥digo existente
2. **NO agregar campos nuevos obligatorios** (como slug) - Solo si el c√≥digo frontend lo soporta
3. **Mantener nombres de columnas exactamente iguales** - Evitar errores de consulta
4. **Desactivar confirmaci√≥n de email** durante desarrollo para facilitar pruebas
5. **Bucket debe llamarse exactamente "anuncios"** - El c√≥digo frontend lo busca con ese nombre
6. **Las llaves de Supabase son p√∫blicas** - No es necesario ocultarlas en el c√≥digo cliente

---

## üöÄ Pr√≥ximos Pasos

1. Completar la migraci√≥n de todas las tablas
2. Poblar datos de categor√≠as y provincias
3. Crear usuarios de prueba
4. Probar flujo completo de la aplicaci√≥n
5. Verificar que las im√°genes se suban correctamente
6. Validar sistema de likes y favoritos
7. Probar planes de pago y cortes√≠as
8. Revisar sistema de rese√±as

---

## üìû Contacto y Soporte

Para continuar la migraci√≥n en una nueva conversaci√≥n, comparte este documento y contin√∫a desde el **Estado Actual**.

---

**√öltima actualizaci√≥n:** 31 de enero de 2026
**Proyecto:** Mercado Central
**Versi√≥n:** 2.0 (Migraci√≥n)
